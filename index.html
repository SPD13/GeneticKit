<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <!-- DataTable CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css"
          crossorigin="anonymous">

    <title>Hello, world!</title>
</head>
<body>

<div class="container">

    <ul class="nav nav-tabs" id="mainTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="cover-tab" data-toggle="tab" href="#cover" role="tab" aria-controls="cover"
               aria-selected="true">Cover</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="editor-tab" data-toggle="tab" href="#editor" role="tab" aria-controls="editor"
               aria-selected="false">Gene Editor</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="export-tab" data-toggle="tab" href="#export" role="tab" aria-controls="export"
               aria-selected="false">Export</a>
        </li>
    </ul>
    <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="cover" role="tabpanel" aria-labelledby="cover-tab">
            <input type="file" name="inputgenfile" id="inputgenfile">
            <br>
            <input type="file" name="inputgnofile" id="inputgnofile">
            <pre id="file_loading_output"></pre>
        </div>
        <div class="tab-pane fade" id="editor" role="tabpanel" aria-labelledby="editor-tab">
            <pre id="output"></pre>
            <table id="genes_table">
                <tr>
                    <th>#</th>
                    <th>Gen</th>
                    <th>G-ID</th>
                    <th>Var</th>
                    <th>Switch On</th>
                    <th>Sex</th>
                    <th>Mut</th>
                    <th>Description</th>
                    <th>Type</th>
                </tr>
            </table>
        </div>
        <div class="tab-pane fade" id="export" role="tabpanel" aria-labelledby="export-tab">
            <button type="button" class="btn btn-primary" onclick="saveGENFile()">Save GEN</button>
        </div>
    </div>
</div>


<div class="modal fade" id="geneModal" tabindex="-1" role="dialog" aria-labelledby="geneModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="geneModalLabel">Gene</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="container">
                    <form>
                        <div id="geneModalGeneHeader"></div>
                        <div id="geneModalSpecialized"></div>
                    </form>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onClick="saveGeneModal()">Save changes</button>
            </div>
        </div>
    </div>
</div>


<div class="d-none">
    <!-- Hidden Prepared UI Templates -->

    <!-- Gene Header: Common to all Genes -->
    <div class="card" id="geneHeader">
        <div class="card-body">
            <h5 class="card-title">Gene Header</h5>
            <div class="form-row align-items-center">
                <div class="col-auto">
                    <select class="form-control" id="headerAge">
                        <option value="0">Embryo</option>
                        <option value="1">Child</option>
                        <option value="2">Adolescent</option>
                        <option value="3">Youth</option>
                        <option value="4">Adult</option>
                        <option value="5">Old</option>
                        <option value="6">Senile</option>
                    </select>
                </div>
                <div class="col-auto">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="headerDup">
                        <label class="form-check-label" for="headerDup">
                            Dup
                        </label>
                    </div>
                </div>
                <div class="col-auto">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="headerMut">
                        <label class="form-check-label" for="headerMut">
                            Mut.
                        </label>
                    </div>
                </div>
                <div class="col-auto">
                    <div class="row">
                        <div class="col-auto pull-left">
                            <label class="control-label">Degree:</label>
                        </div>
                        <div class="col-auto">
                            <input type="text" class="form-control" id="headerDegree"/>
                        </div>
                    </div>
                </div>
                <div class="col-auto">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="headerCut">
                        <label class="form-check-label" for="headerCut">
                            Cut
                        </label>
                    </div>
                </div>
            </div>
            <div class="form-row align-items-center">
                <div class="col-auto">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="headerSex"
                               id="headerSexB" value="B">
                        <label class="form-check-label" for="headerSexB">B</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="headerSex"
                               id="headerSexM" value="M">
                        <label class="form-check-label" for="headerSexM">M</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="headerSex"
                               id="headerSexF" value="F">
                        <label class="form-check-label" for="headerSexF">F</label>
                    </div>
                </div>
                <div class="col-auto">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="headerNotExpressed">
                        <label class="form-check-label" for="headerNotExpressed">
                            Do not express (carry)
                        </label>
                    </div>
                </div>
                <div class="col-auto">
                    <div class="row">
                        <div class="col-auto pull-left">
                            <label class="control-label">Variant</label>
                        </div>
                        <div class="col-auto">
                            <input type="text" class="form-control" id="headerVariant"/>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-row align-items-center">
                <textarea class="form-control" name="geneNotes">
                </textarea>
            </div>
        </div>
    </div>

    <!-- Brain Lobe -->
    <div id="geneLobe">
        <ul class="nav nav-tabs" id="lobeTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="lobegeneral-tab" data-toggle="tab" href="#lobegeneral" role="tab"
                   aria-controls="lobegeneral"
                   aria-selected="true">General</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="lobeprocessing-tab" data-toggle="tab" href="#lobeprocessing" role="tab"
                   aria-controls="lobeprocessing"
                   aria-selected="false">Processing</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="lobe-svrule-input-tab" data-toggle="tab" href="#lobe-svrule-input" role="tab"
                   aria-controls="lobe-svrule-input"
                   aria-selected="false">SV Rule Input</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="lobe-svrule-update-tab" data-toggle="tab" href="#lobe-svrule-update" role="tab"
                   aria-controls="lobe-svrule-update"
                   aria-selected="false">SV Rule Update</a>
            </li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane fade show active" id="lobegeneral" role="tabpanel" aria-labelledby="lobegeneral-tab">

                <div class="row">
                    <div class="form-row align-items-center">
                        <div class="col-auto">
                            <div class="col-auto">
                                <div class="row">
                                    <div class="col-auto pull-left">
                                        <label class="control-label">Lobe ID</label>
                                    </div>
                                    <div class="col-auto">
                                        <input type="text" class="form-control" id="lobeID"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div id="lobeLabel">User Defined Lobe</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Lobe Position and Size</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="row">
                                            <div class="col-md-4 pull-left">
                                                <label class="control-label">X</label>
                                            </div>
                                            <div class="col-md-8">
                                                <input type="text" class="form-control" id="lobeX"/>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="row">
                                            <div class="col-mdd-4 pull-left">
                                                <label class="control-label">Width</label>
                                            </div>
                                            <div class="col-md-8">
                                                <input type="text" class="form-control" id="lobeWidth"/>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="row">
                                            <div class="col-md-4 pull-left">
                                                <label class="control-label">Y</label>
                                            </div>
                                            <div class="col-md-8">
                                                <input type="text" class="form-control" id="lobeY"/>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="row">
                                            <div class="col-md-4 pull-left">
                                                <label class="control-label">Height</label>
                                            </div>
                                            <div class="col-md-8">
                                                <input type="text" class="form-control" id="lobeHeight"/>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Colour</h5>
                                <div class="form-row align-items-center">
                                    <div class="col-auto">
                                        <label class="control-label">Red</label>
                                    </div>
                                    <div class="col-auto">
                                        <input type="range" class="custom-range" min="0" max="255" id="lobeColourR">
                                    </div>
                                </div>
                                <div class="form-row align-items-center">
                                    <div class="col-auto">
                                        <label class="control-label">Green</label>
                                    </div>
                                    <div class="col-auto">
                                        <input type="range" class="custom-range" min="0" max="255" id="lobeColourG">
                                    </div>
                                </div>
                                <div class="form-row align-items-center">
                                    <div class="col-auto">
                                        <label class="control-label">Blue</label>
                                    </div>
                                    <div class="col-auto">
                                        <input type="range" class="custom-range" min="0" max="255" id="lobeColourB">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="lobeprocessing" role="tabpanel" aria-labelledby="lobeprocessing-tab">
                <div class="row">
                    <div class="col-md-4 pull-left">
                        <label class="control-label">Tissue ID</label>
                    </div>
                    <div class="col-md-8">
                        <input type="text" class="form-control" id="lobeTissueID"/>
                    </div>
                </div>
                <div class="row">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="lobeInitRuleRunsAlways">
                        <label class="form-check-label" for="lobeInitRuleRunsAlways">
                            Initialization Rule runs always
                        </label>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 pull-left">
                        <label class="control-label">UpdateTime (0 = No Update)</label>
                    </div>
                    <div class="col-md-8">
                        <input type="text" class="form-control" id="lobeUpdateTime"/>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 pull-left">
                        <label class="control-label">WTA (Winner Takes All) - Not Used?</label>
                    </div>
                    <div class="col-md-8">
                        <input type="text" class="form-control" id="lobeWTA"/>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="lobe-svrule-input" role="tabpanel" aria-labelledby="lobe-svrule-input-tab">
                <div id="lobe-input-svrule">
                </div>
            </div>
            <div class="tab-pane fade" id="lobe-svrule-update" role="tabpanel" aria-labelledby="lobe-svrule-update-tab">
                <div id="lobe-update-svrule">
                </div>
            </div>
        </div>
    </div>

    <!-- Brain Lobe Tract -->
    <div id="geneLobeTract">
        <ul class="nav nav-tabs" id="lobetractTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="lobetractgeneral-tab" data-toggle="tab" href="#lobetractgeneral" role="tab"
                   aria-controls="lobetractgeneral"
                   aria-selected="true">General</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="lobetractconnectivity-tab" data-toggle="tab" href="#lobetractconnectivity" role="tab"
                   aria-controls="lobetractconnectivity"
                   aria-selected="false">Connectivity</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="lobetract-svrule-input-tab" data-toggle="tab" href="#lobetract-svrule-input" role="tab"
                   aria-controls="lobetract-svrule-input"
                   aria-selected="false">SV Rule Input</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="lobetract-svrule-update-tab" data-toggle="tab" href="#lobetract-svrule-update" role="tab"
                   aria-controls="lobetract-svrule-update"
                   aria-selected="false">SV Rule Update</a>
            </li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane fade show active" id="lobetractgeneral" role="tabpanel" aria-labelledby="lobetractgeneral-tab">

            </div>
            <div class="tab-pane fade" id="lobetractconnectivity" role="tabpanel" aria-labelledby="lobetractconnectivity-tab">

            </div>
            <div class="tab-pane fade" id="lobetract-svrule-input" role="tabpanel" aria-labelledby="lobetract-svrule-input-tab">

            </div>
            <div class="tab-pane fade" id="lobetract-svrule-update" role="tabpanel" aria-labelledby="lobetract-svrule-update-tab">

            </div>
        </div>
    </div>

    <!-- SV Rule Code-->
    <div id="SVRule">
        <div name="svrule_code">
        </div>
        <div name="svrule_comments">
            <textarea class="form-control" name="svrule_comment">
            </textarea>
        </div>
    </div>

    <div class="row" id="SVRuleCode">
        <div class="form-row align-items-center">
            <div class="col-md-2" name="svrule_label">
                Line 1
            </div>
            <div class="col-md-2">
                <select class="form-control" name="svrule_opcode">
                    <option value="0">stop</option>
                    <option value="1">blank</option>
                    <option value="2">store in</option>
                    <option value="3">load from</option>
                    <option value="4">if =</option>
                    <option value="5">if <></option>
                    <option value="6">if ></option>
                    <option value="7">if <</option>
                    <option value="8">if >=</option>
                    <option value="9">if <=</option>
                    <option value="10">if zero</option>
                    <option value="11">if non-zero</option>
                    <option value="12">if positive</option>
                    <option value="13">if negative</option>
                    <option value="14">if non-negative</option>
                    <option value="15">if non-positive</option>
                    <option value="16">add</option>
                    <option value="17">substract</option>
                    <option value="18">substract from</option>
                    <option value="19">multiply by</option>
                    <option value="20">divide by</option>
                    <option value="21">divide into</option>
                    <option value="22">minimum width</option>
                    <option value="23">maximum width</option>
                    <option value="24">set tend rate</option>
                    <option value="25">tend to</option>
                    <option value="26">load negation of</option>
                    <option value="27">load abs of</option>
                    <option value="28">get distance to</option>
                    <option value="29">flip around</option>
                    <option value="30">no operation</option>
                    <option value="31">register as spare</option>
                    <option value="32">bound in [0,1]</option>
                    <option value="33">bound in [-1,1]</option>
                    <option value="34">add and store in</option>
                    <option value="35">tend to, store in</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-control" name="svrule_operand">
                    <option value="0">accumulator</option>
                    <option value="1">input neuron</option>
                    <option value="2">dendrite</option>
                    <option value="3">neuron</option>
                    <option value="4">spare neuron</option>
                    <option value="5">random</option>
                    <option value="6">source chemical</option>
                    <option value="7">chemical</option>
                    <option value="8">destination chemical</option>
                    <option value="9">zero</option>
                    <option value="10">one</option>
                    <option value="11">value</option>
                    <option value="12">negative value</option>
                    <option value="13">Value x10</option>
                    <option value="14">Value /10</option>
                    <option value="15">Value Integer</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-control" name="svrule_value_select">
                </select>
                <input type="range" class="custom-range" min="0" max="255" name="svrule_value_number">
                <span name="svrule_value_number_label">0</span>
            </div>
            <div class="col-md-3">
                <input type="text" class="form-control" name="svrule_comment"/>
            </div>
        </div>
    </div>

</div>

<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
<script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js" crossorigin="anonymous"></script>

<!-- GeneticKit JS Files -->
<script src="GeneticKitClasses.js"></script>
<script src="GeneticKitStrings.js"></script>
<script src="utils.js"></script>

<script type="text/javascript">
    var genes = [];
    var sv_notes = [];
    var gene_notes = [];

    (function (document) {
        var inputgen = document.getElementById("inputgenfile"),
            inputgno = document.getElementById("inputgnofile"),
            output = document.getElementById('output');

        // Eventhandler for GEN file input.
        function openGENfile(evt) {
            var files = inputgen.files;
            // Pass the file to the blob, not the input[0].
            fileData = new Blob([files[0]]);
            // Pass getBuffer to promise.
            var promise = new Promise(getBuffer(fileData));
            // Wait for promise to be resolved, or log error.
            promise.then(function (data) {
                gene_number = 0;
                var header = String.fromCharCode.apply(null, data.slice(0, 4));
                if (header == 'dna3') {
                    i = 4;
                    while (i < data.length && String.fromCharCode.apply(null, data.slice(i, i + 4)) == 'gene') {
                        //detect gene end
                        var gene_start = i + 4;
                        var gene_end = i + 4;
                        while (i < data.length && gene_end == gene_start) {
                            i++;
                            if (String.fromCharCode.apply(null, data.slice(i, i + 4)) == 'gene' || String.fromCharCode.apply(null, data.slice(i, i + 4)) == 'gend') {
                                gene_end = i;
                                break;
                            }
                        }
                        genes.push(new Gene(data.slice(gene_start, gene_end), gene_number));
                        gene_number++;
                    }
                    buildDataTable(genes);
                    $("#file_loading_output").html("GEN File loaded successfuly!");
                } else {
                    $("#file_loading_output").html("ERROR: Wrong header: " + header);
                }

            }).catch(function (err) {
                console.log('Error: ', err);
            });
        }

        function openGNOfile(evt) {
            var files = inputgno.files;
            // Pass the file to the blob, not the input[0].
            fileData = new Blob([files[0]]);
            // Pass getBuffer to promise.
            var promise = new Promise(getBuffer(fileData));
            // Wait for promise to be resolved, or log error.
            promise.then(function (data) {
                sv_notes_nb = intFromBytes(data.slice(2, 4));
                var cursor = 4;
                for (var i = 0; i < sv_notes_nb; i++) {
                    start_cursor = cursor;
                    cursor += 10;
                    for (var j = 0; j < 16; j++) {
                        str_size = intFromBytes(data.slice(cursor, cursor + 2));
                        cursor += 2;
                        cursor += str_size;
                    }
                    cursor += 2;
                    str_size = intFromBytes(data.slice(cursor, cursor + 2));
                    cursor += 2 + str_size;
                    sv_notes.push(new SVNote(data.slice(start_cursor, cursor)));
                }
                cursor += 2;
                var pad = 0;
                while (pad == 0) {
                    pad = intFromBytes(data.slice(cursor, cursor + 1));
                    cursor += 2;
                }
                if (pad == 2) {
                    gene_notes_nb = intFromBytes(data.slice(cursor, cursor + 2));
                    cursor += 2;
                    for (var i = 0; i < gene_notes_nb; i++) {
                        var start_cursor = cursor;
                        cursor += 8;
                        str_size = intFromBytes(data.slice(cursor, cursor + 2));
                        cursor += 2;
                        cursor += str_size;
                        str_size = intFromBytes(data.slice(cursor, cursor + 2));
                        cursor += 2;
                        cursor += str_size;
                        gene_notes.push(new GeneNote(data.slice(start_cursor, cursor)));
                    }
                }
                console.log("Red " + sv_notes.length + " SV Notes and " + gene_notes.length + " gene notes");
                attachGNOtoGEN();
                $("#file_loading_output").html("GNO File loaded successfuly!");
            }).catch(function (err) {
                $("#file_loading_output").html("ERROR loading GNO File");
                console.log('Error: ', err);
            });
        }

        /*
          Create a function which will be passed to the promise
          and resolve it when FileReader has finished loading the file.
        */
        function getBuffer(fileData) {
            return function (resolve) {
                var reader = new FileReader();
                reader.readAsArrayBuffer(fileData);
                reader.onload = function () {
                    var arrayBuffer = reader.result
                    var bytes = new Uint8Array(arrayBuffer);
                    resolve(bytes);
                }
            }
        }

        // Eventlistener for file input.
        inputgen.addEventListener('change', openGENfile, false);
        inputgno.addEventListener('change', openGNOfile, false);

    }(document));


    function attachGNOtoGEN() {
        //Attach Gene notes
        for (var i = 0; i < gene_notes.length; i++) {
            var gene = getGene(gene_notes[i].GeneType, gene_notes[i].GeneSubType, gene_notes[i].UniqueId);
            if (gene) {
                gene.setGeneNote(gene_notes[i]);
            }
        }
        //Attach SV Notes
        for (var i = 0; i < sv_notes.length; i++) {
            var gene = getGene(sv_notes[i].GeneType, sv_notes[i].GeneSubType, sv_notes[i].UniqueId);
            if (gene && gene.SpecialiazedObj) {
                gene.SpecialiazedObj.setSVNote(sv_notes[i]);
            }
        }
        refreshDataTable();
    }

    function getGene(GeneType, GeneSubType, GeneId) {
        for (var i = 0; i < genes.length; i++) {
            if (genes[i].GeneType == GeneType && genes[i].GeneSubType == GeneSubType && genes[i].GeneId == GeneId) {
                return genes[i];
            }
        }
        return false;
    }

    var table;

    function buildDataTable(data_table) {
        table = $('#genes_table').DataTable({
            data: data_table,
            columns: [
                {title: '#', data: 'EntryNumber'},
                {title: 'Gen #', data: 'Generation'},
                {title: 'G-ID', data: 'GeneId'},
                {title: 'Variant', data: 'Variant'},
                {title: 'Switch On', data: 'switchOnString'},
                {title: 'Sex', data: 'sexString'},
                {title: 'Mut.', data: 'MutabilityWeighting'},
                {title: 'Description', data: 'descriptionString'},
                {title: 'Type', data: 'typeString'}
            ]
        });
    }

    function refreshDataTable() {
        if (table) {
            // Clear table
            table.clear();

            // Add updated data
            table.rows.add(genes);

            // Redraw table
            table.draw();
        }
    }

    function saveGENFile() {
        if (genes.length > 0) {
            var array = new Uint8Array([]);
            array = mergeUint8Arrays(array, string2Bin("dna3"));
            for (var i = 0; i < genes.length; i++) {
                array = mergeUint8Arrays(array, string2Bin("gene"));
                array = mergeUint8Arrays(array, genes[i].getBytes());
            }
            array = mergeUint8Arrays(array, string2Bin("gend"));
            saveByteArray(new Uint8Array(array), 'test.gen');
        }
    }

    var saveByteArray = (function () {
        var a = document.createElement("a");
        document.body.appendChild(a);
        a.style = "display: none";
        return function (data, name) {
            var blob = new Blob([data], {type: "application/octet-stream"}),
                url = window.URL.createObjectURL(blob);
            a.href = url;
            a.download = name;
            a.click();
            window.URL.revokeObjectURL(url);
        };
    }());

    function clearSelection() {
        if (document.selection && document.selection.empty) {
            document.selection.empty();
        } else if (window.getSelection) {
            var sel = window.getSelection();
            sel.removeAllRanges();
        }
    }

    $(document).ready(function () {
        //DataTable
        $('#genes_table tbody').on('click', 'tr', function () {
            if ($(this).hasClass('selected')) {
                $(this).removeClass('selected');
            } else {
                table.$('tr.selected').removeClass('selected');
                $(this).addClass('selected');
            }
        });

        $('#genes_table tbody').on('dblclick', 'tr', function () {
            if ($(this).hasClass('selected')) {
                $(this).removeClass('selected');
            } else {
                table.$('tr.selected').removeClass('selected');
                $(this).addClass('selected');
            }
            clearSelection();
            startGeneModal(table.row(this).data());
        });
    });

    //UI: Modal boxes
    var edited_gene = null;

    $( document ).ready(function() {
        initUI();
    });

    function initUI() {
        //Programmatically replicate SVRules controls
        //Lobe UI
        $('#lobe-input-svrule').append(initUISVRule("lobe_input"));
        $('#lobe-update-svrule').append(initUISVRule("lobe_update"));
    }

    function initUISVRule(prefix) {
        rule = $('#SVRule').clone();
        rule.attr("id", prefix+"_svrule");
        rule.find('textarea[name=svrule_comment]').attr("id", prefix+"_svrule_general_comment");
        for (var i=0; i<16; i++) {
            //Init Lobe SVRule
            rulecode = $('#SVRuleCode').clone();
            rulecode.find('div[name=svrule_label]').html("Line " + (i + 1));
            rulecode.find('div[name=svrule_label]').attr("id", prefix+"_svrule_label_" + i);
            rulecode.find('select[name=svrule_opcode]').attr("id", prefix+"_svrule_opcode_" + i);
            rulecode.find('select[name=svrule_opcode]').attr("gk-index", i);
            rulecode.find('select[name=svrule_opcode]').attr("gk-prefix", prefix+"_svrule");
            rulecode.find('select[name=svrule_opcode]').change(function () {
                updateSVCodeSelectorOp($(this));
            });
            rulecode.find('select[name=svrule_operand]').attr("id", prefix+"_svrule_operand_" + i);
            rulecode.find('select[name=svrule_operand]').attr("gk-index", i);
            rulecode.find('select[name=svrule_operand]').attr("gk-prefix", prefix+"_svrule_value");
            rulecode.find('select[name=svrule_operand]').change(function () {
                updateSVCodeSelectorVal($(this), false);
                var prefix = $(this).attr("gk-prefix");
                var index = $(this).attr("gk-index");
                updateSVCodeValueLabel($('#'+prefix + index + "_number"));
            });
            rulecode.find('select[name=svrule_value_select]').attr("id", prefix+"_svrule_value_" + i + "_select");
            rulecode.find('input[name=svrule_value_number]').attr("id", prefix+"_svrule_value_" + i + "_number");
            rulecode.find('input[name=svrule_value_number]').attr("gk-index", i);
            rulecode.find('input[name=svrule_value_number]').attr("gk-prefix", prefix+"_svrule_value");
            rulecode.find('input[name=svrule_value_number]').change(function () {
                updateSVCodeValueLabel($(this));
            });
            rulecode.find('span[name=svrule_value_number_label]').attr("id", prefix+"_svrule_value_" + i + "_number_label");
            rulecode.find('input[name=svrule_comment]').attr("id", prefix+"_svrule_comment_" + i);
            rule.find('div[name=svrule_code]').append(rulecode);
        }
        return rule;
    }

    function fillSelectWithValues(select_obj, string_table) {
        select_obj.empty();
        for (var i=0; i< string_table.length; i++) {
            select_obj.append("<option value=\""+i+"\">"+string_table[i]+"</option>");
        }
    }

    function updateSVCodeSelectorOp(opcode_select){
        var index = opcode_select.attr("gk-index");
        var prefix = opcode_select.attr("gk-prefix");
        if (opcode_select.val() == 0) {
            //Stop: No other options
            $("#" + prefix + "_operand_" + index).val(0);
            $("#" + prefix + "_operand_" + index).change();
            $("#" + prefix + "_operand_" + index).hide();
        } else {
            $("#" + prefix + "_operand_" + index).show();
        }
    }

    function updateSVCodeValueLabel(number_input) {
        var index = number_input.attr("gk-index");
        var prefix = number_input.attr("gk-prefix");
        prefix = prefix + "_" + index;
        $("#"+prefix+"_number_label").html($("#"+prefix+"_number").val());
    }

    function updateSVCodeSelectorVal(operand_select, value){
        var operand = operand_select.val();
        var index = operand_select.attr("gk-index");
        var prefix = operand_select.attr("gk-prefix");
        prefix = prefix + "_" + index;
        if (operand == 0 || operand == 5 || operand == 9 || operand == 10) {
                //No Value
            $("#"+prefix+"_select").hide();
            $("#"+prefix+"_number").hide();
            $("#"+prefix+"_number_label").hide();
        } else if (operand == 1 || operand == 3 || operand == 4) {
            //Neuron
            fillSelectWithValues($("#"+prefix+"_select"), NeuronVariable_str);
            $("#"+prefix+"_select").show();
            $("#"+prefix+"_number").hide();
            $("#"+prefix+"_number_label").hide();
            if (value) {
                $("#"+prefix+"_select").val(value);
            }
        } else if (operand == 2) {
            //Dendrite
            fillSelectWithValues($("#"+prefix+"_select"), DendriteVariable_str);
            $("#"+prefix+"_select").show();
            $("#"+prefix+"_number").hide();
            $("#"+prefix+"_number_label").hide();
            if (value) {
                $("#"+prefix+"_select").val(value);
            }
        } else if (operand == 6 || operand == 7 || operand == 8) {
            //Chemical
            //TODO: Fill with chemicals list
            $("#"+prefix+"_select").show();
            $("#"+prefix+"_number").hide();
            $("#"+prefix+"_number_label").hide();
            if (value) {
                $("#"+prefix+"_select").val(value);
            }
        } else if (operand >= 11) {
            //Value
            $("#"+prefix+"_select").hide();
            $("#"+prefix+"_number").show();
            $("#"+prefix+"_number_label").show();
            if (operand == 11) {
                //value
                $("#"+prefix+"_number").attr('min', 0);
                $("#"+prefix+"_number").attr('max', 1);
                $("#"+prefix+"_number").attr('step', 0.004);
            } else if (operand == 12) {
                //negative value
                $("#"+prefix+"_number").attr('min', -1);
                $("#"+prefix+"_number").attr('max', 0);
                $("#"+prefix+"_number").attr('step', -0.004);
            } else if (operand == 13) {
                //value x10
                $("#"+prefix+"_number").attr('min', 0);
                $("#"+prefix+"_number").attr('max', 10);
                $("#"+prefix+"_number").attr('step', 0.0403);
            } else if (operand == 14) {
                //value /10
                $("#"+prefix+"_number").attr('min', 0);
                $("#"+prefix+"_number").attr('max', 0.1);
                $("#"+prefix+"_number").attr('step', 0.0004);
            } else if (operand == 15) {
                //value integer
                $("#"+prefix+"_number").attr('min', 0);
                $("#"+prefix+"_number").attr('max', 248);
                $("#"+prefix+"_number").attr('step', 1);
            }
            if (value) {
                $("#"+prefix+"_number").val(value);
            }
        }
    }

    function refreshLobeLabel() {
        if (LobeId_str[$('#lobeID').val()]) {
            $('#lobeLabel').html(LobeId_str[$('#lobeID').val()]);
        } else {
            $('#lobeLabel').html("User defined lobe");
        }
    }

    function startGeneModal(gene_obj) {
        //Init the header
        $('#geneModalGeneHeader').append($('#geneHeader'));

        $('#geneModalLabel').html("(# " + gene_obj.EntryNumber + ") Lobe (Brain: Lobe)");
        $('#headerAge').val(gene_obj.SwitchOnTime);
        if (gene_obj.Duplicable) {
            $('#headerDup').prop('checked', true);
        } else {
            $('#headerDup').prop('checked', false);
        }
        if (gene_obj.Mutable) {
            $('#headerMut').prop('checked', true);
        } else {
            $('#headerMut').prop('checked', false);
        }
        $('#headerDegree').val(gene_obj.MutabilityWeighting);
        if (gene_obj.Deletable) {
            $('#headerCut').prop('checked', true);
        } else {
            $('#headerCut').prop('checked', false);
        }
        if (gene_obj.MaleOnly) {
            $('input:radio[name=headerSex]').filter('[value=B]').prop('checked', false);
            $('input:radio[name=headerSex]').filter('[value=M]').prop('checked', true);
            $('input:radio[name=headerSex]').filter('[value=F]').prop('checked', false);
        } else if (gene_obj.FemaleOnly) {
            $('input:radio[name=headerSex]').filter('[value=B]').prop('checked', false);
            $('input:radio[name=headerSex]').filter('[value=M]').prop('checked', false);
            $('input:radio[name=headerSex]').filter('[value=F]').prop('checked', true);
        } else {
            $('input:radio[name=headerSex]').filter('[value=B]').prop('checked', true);
            $('input:radio[name=headerSex]').filter('[value=M]').prop('checked', false);
            $('input:radio[name=headerSex]').filter('[value=F]').prop('checked', false);
        }
        if (gene_obj.NotExpressed) {
            $('#headerNotExpressed').prop('checked', true);
        } else {
            $('#headerNotExpressed').prop('checked', false);
        }
        $('#headerVariant').val(gene_obj.ExpressionVariant);
        //Gene notes
        if (gene_obj.GeneNoteObj) {
            $('#geneNotes').val(gene_obj.GeneNoteObj.RichText);
        }

        if (gene_obj.GeneType == 0 && gene_obj.GeneSubType == 0) {
            //Brain Lobe
            $('#geneModalSpecialized').append($('#geneLobe'));
            $('#lobeID').val(gene_obj.SpecialiazedObj.LobeId);
            refreshLobeLabel();
            $('#lobeX').val(gene_obj.SpecialiazedObj.X);
            $('#lobeY').val(gene_obj.SpecialiazedObj.Y);
            $('#lobeWidth').val(gene_obj.SpecialiazedObj.Width);
            $('#lobeHeight').val(gene_obj.SpecialiazedObj.Height);
            $('#lobeColourR').val(gene_obj.SpecialiazedObj.Red);
            $('#lobeColourG').val(gene_obj.SpecialiazedObj.Green);
            $('#lobeColourB').val(gene_obj.SpecialiazedObj.Blue);
            $('#lobeTissueID').val(gene_obj.SpecialiazedObj.Tissue);
            $('#lobeWTA').val(gene_obj.SpecialiazedObj.WTA);
            $('#lobeUpdateTime').val(gene_obj.SpecialiazedObj.UpdateTime);
            if (gene_obj.SpecialiazedObj.Spare[0]) {
                $('#lobeInitRuleRunsAlways').prop('checked', true);
            } else {
                $('#lobeInitRuleRunsAlways').prop('checked', false);
            }
            //SVRules
            for (var i=0; i<16; i++) {
                //Init SV Rule
                if (i<gene_obj.SpecialiazedObj.InitSVRule.Codes.length) {
                    code = gene_obj.SpecialiazedObj.InitSVRule.Codes[i];
                    $('#lobe_input_svrule_opcode_'+i).val(code.Opcode);
                    $('#lobe_input_svrule_operand_'+i).val(code.Operand);
                    updateSVCodeSelectorVal($('#lobe_input_svrule_operand_'+i), code.Value);
                    updateSVCodeValueLabel($('#lobe_input_svrule_value_'+i+"_number"));
                    updateSVCodeSelectorOp($('#lobe_input_svrule_opcode_'+i));
                    if (gene_obj.SpecialiazedObj.InitSVRule.SVNoteObj && i<gene_obj.SpecialiazedObj.InitSVRule.SVNoteObj.Annotations.length) {
                        $('#lobe_input_svrule_comment_' + i).val(gene_obj.SpecialiazedObj.InitSVRule.SVNoteObj.Annotations[i]);
                    }
                }
                //Update SV Rule
                if (i<gene_obj.SpecialiazedObj.UpdateSVRule.Codes.length) {
                    code = gene_obj.SpecialiazedObj.UpdateSVRule.Codes[i];
                    $('#lobe_update_svrule_opcode_'+i).val(code.Opcode);
                    $('#lobe_update_svrule_operand_'+i).val(code.Operand);
                    updateSVCodeSelectorVal($('#lobe_update_svrule_operand_'+i), code.Value);
                    updateSVCodeValueLabel($('#lobe_update_svrule_value_'+i+"_number"));
                    updateSVCodeSelectorOp($('#lobe_update_svrule_opcode_'+i));
                    if (gene_obj.SpecialiazedObj.UpdateSVRule.SVNoteObj && i<gene_obj.SpecialiazedObj.UpdateSVRule.SVNoteObj.Annotations.length) {
                        $('#lobe_update_svrule_comment_' + i).val(gene_obj.SpecialiazedObj.UpdateSVRule.SVNoteObj.Annotations[i]);
                    }
                }
            }
            //SVRules General notes
            if (gene_obj.SpecialiazedObj.InitSVRule.SVNoteObj && gene_obj.SpecialiazedObj.InitSVRule.SVNoteObj.GeneralNotes) {
               $('#lobe_init_svrule_general_comment').val(gene_obj.SpecialiazedObj.InitSVRule.SVNoteObj.GeneralNotes);
            }
            if (gene_obj.SpecialiazedObj.UpdateSVRule.SVNoteObj && gene_obj.SpecialiazedObj.UpdateSVRule.SVNoteObj.GeneralNotes) {
                $('#lobe_update_svrule_general_comment').val(gene_obj.SpecialiazedObj.UpdateSVRule.SVNoteObj.GeneralNotes);
            }
        }

        edited_gene = gene_obj;
        $('#geneModal').modal();
    }

    function saveGeneModal() {
        if (edited_gene) {
            edited_gene.SwitchOnTime = $('#headerAge').val();
            if ($('#headerDup').prop('checked')) {
                edited_gene.Duplicable = true;
            } else {
                edited_gene.Duplicable = false;
            }
            if ($('#headerMut').prop('checked')) {
                edited_gene.Mutable = true;
            } else {
                edited_gene.Mutable = false;
            }
            edited_gene.MutabilityWeighting = $('#headerDegree').val();
            if ($('#headerCut').prop('checked')) {
                edited_gene.Deletable = true;
            } else {
                edited_gene.Deletable = false;
            }
            var sex = $("input:radio[name ='headerSex']:checked").val();
            if (sex == "M") {
                edited_gene.MaleOnly = true;
                edited_gene.FemaleOnly = false;
            } else if (sex == "F") {
                edited_gene.MaleOnly = false;
                edited_gene.FemaleOnly = true;
            } else {
                edited_gene.MaleOnly = false;
                edited_gene.FemaleOnly = false;
            }
            if ($('#headerNotExpressed').prop('checked')) {
                edited_gene.NotExpressed = true;
            } else {
                edited_gene.NotExpressed = false;
            }
            edited_gene.ExpressionVariant = $('#headerVariant').val();
            //Gene note
            note_obj = edited_gene.GeneNoteObj;
            if (!note_obj) {
                note_obj = new GeneNote(null);
                edited_gene.GeneNoteObj = note_obj;
            }
            note_obj.RichText = $('#geneNotes').val();

            if (edited_gene.GeneType == 0 && edited_gene.GeneSubType == 0) {
                //Brain Lobe
                edited_gene.SpecialiazedObj.LobeId = $('#lobeID').val();
                edited_gene.SpecialiazedObj.X = $('#lobeX').val();
                edited_gene.SpecialiazedObj.Y = $('#lobeY').val();
                edited_gene.SpecialiazedObj.Width = $('#lobeWidth').val();
                edited_gene.SpecialiazedObj.Height = $('#lobeHeight').val();
                edited_gene.SpecialiazedObj.Red = $('#lobeColourR').val();
                edited_gene.SpecialiazedObj.Green = $('#lobeColourG').val();
                edited_gene.SpecialiazedObj.Blue = $('#lobeColourB').val();
                edited_gene.SpecialiazedObj.Tissue = $('#lobeTissueID').val();
                edited_gene.SpecialiazedObj.UpdateTime = $('#lobeUpdateTime').val();
                edited_gene.SpecialiazedObj.WTA = $('#lobeWTA').val();
                if ($('#lobeInitRuleRunsAlways').prop('checked')) {
                    edited_gene.SpecialiazedObj.Spare[0] = 1;
                } else {
                    edited_gene.SpecialiazedObj.Spare[0] = 0;
                }
                //SVRules
                for (var i = 0; i < 16; i++) {
                    //Init rule
                    var code = edited_gene.SpecialiazedObj.InitSVRule.Codes[i];
                    code.Opcode = $('#lobe_input_svrule_opcode_' + i).val();
                    code.Operand = $('#lobe_input_svrule_operand_' + i).val();
                    if (code.Operand == 0 || code.Operand == 5 || code.Operand == 9 || code.Operand == 10) {
                        code.Value = 0;
                    } else if (code.Operand < 11) {
                        code.Value = $('#lobe_input_svrule_value_' + i + "_select").val();
                    } else {
                        code.Value = $('#lobe_input_svrule_value_' + i + "_number").val();
                    }
                    //SVNote
                    note_obj = edited_gene.SpecialiazedObj.InitSVRule.SVNoteObj;
                    if (!note_obj) {
                        note_obj = new SVNote(null);
                        edited_gene.SpecialiazedObj.InitSVRule.SVNoteObj = note_obj;
                    }
                    note_obj.Annotations[i] = $('#lobe_input_svrule_comment_' + i).val();

                    //Update rule
                    code = edited_gene.SpecialiazedObj.UpdateSVRule.Codes[i];
                    code.Opcode = $('#lobe_update_svrule_opcode_' + i).val();
                    code.Operand = $('#lobe_update_svrule_operand_' + i).val();
                    if (code.Operand == 0 || code.Operand == 5 || code.Operand == 9 || code.Operand == 10) {
                        code.Value = 0;
                    } else if (code.Operand < 11) {
                        code.Value = $('#lobe_update_svrule_value_' + i + "_select").val();
                    } else {
                        code.Value = $('#lobe_update_svrule_value_' + i + "_number").val();
                    }
                    //SVNote
                    note_obj = edited_gene.SpecialiazedObj.UpdateSVRule.SVNoteObj;
                    if (!note_obj) {
                        note_obj = new SVNote(null);
                        edited_gene.SpecialiazedObj.UpdateSVRule.SVNoteObj = note_obj;
                    }
                    note_obj.Annotations[i] = $('#lobe_update_svrule_comment_' + i).val();
                }
                //SVRules General notes
                edited_gene.SpecialiazedObj.InitSVRule.SVNoteObj.GeneralNotes = $('#lobe_init_svrule_general_comment').val();
                edited_gene.SpecialiazedObj.UpdateSVRule.SVNoteObj.GeneralNotes = $('#lobe_update_svrule_general_comment').val();
            }
        }

        refreshDataTable();
        $('#geneModal').modal('hide');
    }

</script>
</body>
</html>